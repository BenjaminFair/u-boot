/*---------------------------------------------------------------------------------------------------------*/
/*  Nuvoton Technology Corporation confidential                                                            */
/*                                                                                                         */
/*  Copyright (c) 2008 by Nuvoton Technology Corporation                                                   */
/*  All rights reserved                                                                                    */
/*                                                                                                         */
/*<<<------------------------------------------------------------------------------------------------------*/
/* File Contents:                                                                                          */
/*   TIMER_drv.c                                                                                           */
/*            This file contains TIMER module implementation                                               */
/*  Project:                                                                                               */
/*            BMC HAL                                                                                      */
/*---------------------------------------------------------------------------------------------------------*/

#include "../../../Common/hal_common.h"
#include "../../../Chips/chip.h"

#include "timer_drv.h"
#include "timer_regs.h"

#include "../../aic/aic_if.h"
#include "../../clk/clk_if.h"

/*---------------------------------------------------------------------------------------------------------*/
/* Array of timer counters                                                                                 */
/*---------------------------------------------------------------------------------------------------------*/
volatile static UINT32 TIMER_tickCount[TIMER_NUM_OF_PORTS] = {0};

/*---------------------------------------------------------------------------------------------------------*/
/* Array of timer interrupt handlers                                                                       */
/*---------------------------------------------------------------------------------------------------------*/
static AIC_Isr_T TIMER_handler[TIMER_NUM_OF_PORTS] = {0};

/*---------------------------------------------------------------------------------------------------------*/
/* Array of timer interrupt handlers args                                                                  */
/*---------------------------------------------------------------------------------------------------------*/
static UINT32 TIMER_handler_args[TIMER_NUM_OF_PORTS] = {0};


/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TIMER_InternalHandler                                                                  */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  arg -                                                                                  */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine is internal TIMER Irq Handler                                             */
/*---------------------------------------------------------------------------------------------------------*/
static HAL_STATUS TIMER_InternalHandler(UINT32 arg)
{
	UINT32 timerNum = (UINT32)arg;

	/*-----------------------------------------------------------------------------------------------------*/
	/* set start TIMER value                                                                               */
	/*-----------------------------------------------------------------------------------------------------*/
	TIMER_tickCount[timerNum]++;

	return HAL_OK;
}



/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TIMER_StartPeriodic                                                                    */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  timerNum        - Timer number                                                         */
/*                  ticksPerSec     - Timer frequency in hertz                                             */
/*                  tickHanlder     - Handler for Timer tick event. If NULL is given, internal event       */
/*                                    handler is used                                                      */
/*                  tickHandlerArg  - Argument to the handler                                              */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine initialization of the timer to perform periodic event.                    */
/*                  If 'tickHandler' is given it is called every 'tickPerSec' tick.                        */
/*                  Otherwise internal handler is increasing internal tick counter for the given timer.    */
/*                  Its value can be read using TIMER_GetTick function                                     */
/*---------------------------------------------------------------------------------------------------------*/
HAL_STATUS TIMER_StartPeriodic(TIMER_DEV_T timerNum, UINT32 ticksPerSec, AIC_Isr_T tickHanlder, void* tickHandlerArg)
{
	UINT32      timerClk = 0;
	UINT32      loadVal  = 0;
	HAL_STATUS  ret = HAL_OK;

	/*-----------------------------------------------------------------------------------------------------*/
	/* Error handling                                                                                      */
	/*-----------------------------------------------------------------------------------------------------*/
	if (timerNum >= TIMER_NUM_OF_PORTS)
	{
        return HAL_ERROR_BAD_DEVNUM;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* Configuring the Timer clock                                                                         */
	/*-----------------------------------------------------------------------------------------------------*/
	timerClk = CLK_ConfigureTimerClock();

	/*-----------------------------------------------------------------------------------------------------*/
	/* Cleaning the status register                                                                        */
	/*-----------------------------------------------------------------------------------------------------*/
	REG_WRITE(TIMER_TCSR(timerNum), 0);

	/*-----------------------------------------------------------------------------------------------------*/
	/* Clearing the timer counter                                                                          */
	/*-----------------------------------------------------------------------------------------------------*/
	TIMER_tickCount[timerNum]=0;

	/*-----------------------------------------------------------------------------------------------------*/
	/* Periodic interrupt mode                                                                             */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_MODE, TCSR_MODE_PERIODIC);

	/*-----------------------------------------------------------------------------------------------------*/
	/* set start TIMER value                                                                               */
	/*-----------------------------------------------------------------------------------------------------*/
	if (ticksPerSec == 0)
	{
        loadVal = 0xFFFFFFFF;
        ret = HAL_ERROR_BAD_FREQ;
	}
	else
	{
        loadVal = timerClk / ticksPerSec;
	}
	REG_WRITE(TIMER_TICR(timerNum), loadVal);

	/*-----------------------------------------------------------------------------------------------------*/
	/* Register handler                                                                                    */
	/*-----------------------------------------------------------------------------------------------------*/
	if (tickHanlder != NULL)
	{
        /*-------------------------------------------------------------------------------------------------*/
        /* Registering given handler if given                                                              */
        /*-------------------------------------------------------------------------------------------------*/
        TIMER_handler[timerNum]         = tickHanlder;
        TIMER_handler_args[timerNum]    = (UINT32)tickHandlerArg;
	}
	else
	{
        /*-------------------------------------------------------------------------------------------------*/
        /* Registering internal handler if no handler given                                                */
        /*-------------------------------------------------------------------------------------------------*/
        TIMER_handler[timerNum]         = TIMER_InternalHandler;
        TIMER_handler_args[timerNum]    = (UINT32)timerNum;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* Setting Interrupt muxing                                                                            */
	/*-----------------------------------------------------------------------------------------------------*/
	AIC_EnableGroupInt(TIMER_GROUP_INTERRUPT(timerNum));

#if !defined(NO_INTERNAL_IRQ_HANDLER)
	AIC_RegisterHandler(TIMER_INTERRUPT(timerNum), TIMER_Isr, timerNum);
	AIC_EnableInt(TIMER_INTERRUPT(timerNum));
#endif

	/*-----------------------------------------------------------------------------------------------------*/
	/* Clear interrupt flag                                                                                */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_BIT(TIMER_TISR(timerNum), TIMER_PORT_IN_MODULE(timerNum));

	/*-----------------------------------------------------------------------------------------------------*/
	/* interrupt enable                                                                                    */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_IE, 1);

	/*-----------------------------------------------------------------------------------------------------*/
	/* start TIMER                                                                                         */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_CEN, 1);

	return ret;
}




/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TIMER_StopPeriodic                                                                     */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  timerNum -                                                                             */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine stops the timer started by startPeriodic routine                          */
/*---------------------------------------------------------------------------------------------------------*/
HAL_STATUS TIMER_StopPeriodic(TIMER_DEV_T timerNum)
{
	/*-----------------------------------------------------------------------------------------------------*/
	/* Error handling                                                                                      */
	/*-----------------------------------------------------------------------------------------------------*/
	if (timerNum >= TIMER_NUM_OF_PORTS)
	{
        return HAL_ERROR_BAD_DEVNUM;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* interrupt disable                                                                                   */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_IE, 0);

	/*-----------------------------------------------------------------------------------------------------*/
	/* stop TIMER                                                                                          */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_CEN, 0);

	/*-----------------------------------------------------------------------------------------------------*/
	/* Clearing interrupt handlers                                                                         */
	/*-----------------------------------------------------------------------------------------------------*/
	TIMER_handler[timerNum]         = NULL;
	TIMER_handler_args[timerNum]    = 0;

	return HAL_OK;
}


/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TIMER_StartOneShot                                                                     */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  microSec -    number of micro seconds the timer will count (to zero)                   */
/*                  timerNum -    the timer number to use                                                  */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  Activate timer in OneShot mode, no use of interrupts                                   */
/*---------------------------------------------------------------------------------------------------------*/
HAL_STATUS TIMER_StartOneShot(TIMER_DEV_T timerNum, UINT32 microSec)
{
	UINT32      timerClk = 0;
     INT32      divisor  = 0;
	HAL_STATUS  ret      = HAL_OK;

	/*-----------------------------------------------------------------------------------------------------*/
	/* Error handling                                                                                      */
	/*-----------------------------------------------------------------------------------------------------*/
	if (timerNum >= TIMER_NUM_OF_PORTS)
	{
        return HAL_ERROR_BAD_DEVNUM;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* if microSec is 0 nothing to do                                                                      */
	/*-----------------------------------------------------------------------------------------------------*/
	if (microSec==0)
	{
        return HAL_OK;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* Configure timer source clock:                                                                       */
	/*-----------------------------------------------------------------------------------------------------*/
	timerClk = CLK_ConfigureTimerClock();

	/*-----------------------------------------------------------------------------------------------------*/
	/* Computing divisor                                                                                   */
	/*-----------------------------------------------------------------------------------------------------*/
	divisor = (timerClk/_1MHz_)-1;

	if (divisor < 0)
	{
        divisor = 0;
        ret = HAL_ERROR_BAD_FREQ;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* Set prescaler to produce timer tick each 1uSec:                                                     */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_PRESCALE, divisor);

	/*-----------------------------------------------------------------------------------------------------*/
	/* Clean status register:                                                                              */
	/*-----------------------------------------------------------------------------------------------------*/
	REG_WRITE(TIMER_TCSR(timerNum), 0);

	/*-----------------------------------------------------------------------------------------------------*/
	/* Set one shot mode                                                                                   */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_MODE, TCSR_MODE_ONESHOT);

	/*-----------------------------------------------------------------------------------------------------*/
	/* Load timer value:                                                                                   */
	/*-----------------------------------------------------------------------------------------------------*/
	REG_WRITE(TIMER_TICR(timerNum), microSec);

	/*-----------------------------------------------------------------------------------------------------*/
	/* Start TIMER:                                                                                        */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_CEN, 1);

	return ret;
}


/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TIMER_OneShotRunning                                                                   */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  timerNum -  number of timer to check                                                   */
/*                                                                                                         */
/* Returns:                                                                                                */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*              Checks whether the specified timer is still running (counting)                             */
/*---------------------------------------------------------------------------------------------------------*/
BOOLEAN TIMER_OneShotRunning(TIMER_DEV_T timerNum)
{
	volatile UINT32 i=0;
	volatile UINT32 retval =0;

	/*-----------------------------------------------------------------------------------------------------*/
	/* Error handling                                                                                      */
	/*-----------------------------------------------------------------------------------------------------*/
	if (timerNum >= TIMER_NUM_OF_PORTS)
	{
        return FALSE;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* HW BUG BYPASS:                                                                                      */
	/* Only 4th reading from CACT bit is consistent                                                        */
	/*-----------------------------------------------------------------------------------------------------*/
	for (i=0; i<4; ++i)
	{
        retval = READ_REG_FIELD(TIMER_TCSR(timerNum), TCSR_CACT);
	}

	return retval;
}


/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TIMER_Reset                                                                            */
/*                                                                                                         */
/* Parameters:      none                                                                                   */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine performs TIMER reset                                                      */
/*---------------------------------------------------------------------------------------------------------*/
HAL_STATUS TIMER_Reset (TIMER_DEV_T timerNum)
{
	/*-----------------------------------------------------------------------------------------------------*/
	/* Error handling                                                                                      */
	/*-----------------------------------------------------------------------------------------------------*/
	if (timerNum >= TIMER_NUM_OF_PORTS)
	{
        return HAL_ERROR_BAD_DEVNUM;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* Timer reset                                                                                         */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_CRST, 1);

	return HAL_OK;
}




/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TIMER_GetTick                                                                          */
/*                                                                                                         */
/* Parameters:      none                                                                                   */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine returns TIMER value                                                       */
/*---------------------------------------------------------------------------------------------------------*/
UINT32 TIMER_GetTick(TIMER_DEV_T timerNum)
{
	UINT32 tickCount;

	/*-----------------------------------------------------------------------------------------------------*/
	/* Error handling                                                                                      */
	/*-----------------------------------------------------------------------------------------------------*/
	if (timerNum >= TIMER_NUM_OF_PORTS)
	{
        return 0;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* interrupt disable                                                                                   */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_IE, 0);

	/*-----------------------------------------------------------------------------------------------------*/
	/* Reading timer tick (critical section)                                                               */
	/*-----------------------------------------------------------------------------------------------------*/
	tickCount = TIMER_tickCount[timerNum];

	/*-----------------------------------------------------------------------------------------------------*/
	/* interrupt enable                                                                                    */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_IE, 1);

	return tickCount;
}




/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TIMER_GetHWTick                                                                        */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  timerNum -                                                                             */
/*                                                                                                         */
/* Returns:                                                                                                */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine return the content of the HW ticking register                             */
/*---------------------------------------------------------------------------------------------------------*/
UINT32 TIMER_GetHWTick(TIMER_DEV_T timerNum)
{
	UINT32 hw_tick = 0;

	/*-----------------------------------------------------------------------------------------------------*/
	/* Error handling                                                                                      */
	/*-----------------------------------------------------------------------------------------------------*/
	if (timerNum >= TIMER_NUM_OF_PORTS)
	{
        return 0;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* we stop the counter first, read the value and continue the count                                    */
	/* assuming the core clock is much faster than timer clock, it shouldn't cause missed count            */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_CEN, 0);
	hw_tick = REG_READ(TIMER_TDR(timerNum));
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_CEN, 1);

	return hw_tick;
}


/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TIMER_GetCurrVal                                                                        */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  timerNum -                                                                             */
/*                                                                                                         */
/* Returns:                                                                                                */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine return the content of the HW ticking register                             */
/*---------------------------------------------------------------------------------------------------------*/
UINT32 TIMER_GetCurrVal(TIMER_DEV_T timerNum)
{
	UINT32 val = 0;

	/*-----------------------------------------------------------------------------------------------------*/
	/* Error handling                                                                                      */
	/*-----------------------------------------------------------------------------------------------------*/
	if (timerNum >= TIMER_NUM_OF_PORTS)
	{
        return 0;
	}

	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_CEN, 0);
	val =  REG_READ(TIMER_TDR(timerNum));
	SET_REG_FIELD(TIMER_TCSR(timerNum), TCSR_CEN, 1);

	return val;
}


/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TIMER_WatchdogReset                                                                    */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  timerNum -  number of timer to check                                                   */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine performs watchdog reset                                                   */
/*---------------------------------------------------------------------------------------------------------*/
void TIMER_WatchdogReset(UINT32 timerNum)
{
	volatile INT i = 1;
	REG_WRITE(TIMER_WTCR(timerNum), 0x83);
	while(i);
}



/*---------------------------------------------------------------------------------------------------------*/
/* Function:        TIMER_Isr                                                                              */
/*                                                                                                         */
/* Parameters:                                                                                             */
/*                  data - timer number                                                                    */
/*                                                                                                         */
/* Returns:         none                                                                                   */
/* Side effects:                                                                                           */
/* Description:                                                                                            */
/*                  This routine is TIMER IRQ handler                                                      */
/*---------------------------------------------------------------------------------------------------------*/
HAL_STATUS TIMER_Isr(UINT32 timerNum)
{
	/*-----------------------------------------------------------------------------------------------------*/
	/* Error handling                                                                                      */
	/*-----------------------------------------------------------------------------------------------------*/
	if (timerNum >= TIMER_NUM_OF_PORTS)
	{
        return HAL_ERROR_BAD_DEVNUM;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* Checking if Timer interrupt set                                                                     */
	/*-----------------------------------------------------------------------------------------------------*/
	if (!READ_REG_BIT(TIMER_TISR(timerNum), TIMER_PORT_IN_MODULE(timerNum)))
	{
        /*-------------------------------------------------------------------------------------------------*/
        /* If not, do nothing. (probably bad call to the function)                                         */
        /*-------------------------------------------------------------------------------------------------*/
        return HAL_ERROR_NOT_HANDLED;
	}

	/*-----------------------------------------------------------------------------------------------------*/
	/* Executing the handler                                                                               */
	/*-----------------------------------------------------------------------------------------------------*/
	if (TIMER_handler[timerNum] != NULL)
        TIMER_handler[timerNum](TIMER_handler_args[timerNum]);

	/*-----------------------------------------------------------------------------------------------------*/
	/* Clear interrupt                                                                                     */
	/*-----------------------------------------------------------------------------------------------------*/
	SET_REG_BIT(TIMER_TISR(timerNum), TIMER_PORT_IN_MODULE(timerNum));

	return HAL_OK;
}

